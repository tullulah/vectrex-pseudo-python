use vectrex_emulator::cpu6809::CPU;
use std::fs;

fn main() {
    println!("=== REGENERANDO ARCHIVOS DE COMPARACIÓN ACTUALIZADOS ===");
    
    let bios_path = r"C:\\Users\\DanielFerrerGuerrero\\source\\repos\\pseudo-python\\ide\\frontend\\dist\\bios.bin";
    let bios = fs::read(bios_path).expect("no se pudo leer bios.bin");
    
    // Generar diferentes tamaños
    for &steps in &[100, 500, 1000, 2000, 5000] {
        println!("\nGenerando comparación de {} pasos...", steps);
        
        let mut cpu = CPU::default();
        cpu.load_bios(&bios);
        cpu.reset();
        
        let filename = format!("../emulator_comparison_{}_steps.txt", steps);
        let mut output = String::new();
        
        output.push_str(&format!("=== COMPARACIÓN DE EMULADORES ({} pasos) ===\n", steps));
        output.push_str("Generated by Rust emulator test (UPDATED)\n");
        output.push_str(&format!("BIOS Path: {}\n\n", bios_path));
        
        // Header
        output.push_str("┌──────┬──────┬────────┬────┬────┬──────┬──────┬──────┬──────┬────┬────┐\n");
        output.push_str("│ Step │  PC  │ Opcode │ A  │ B  │  X   │  Y   │  S   │  U   │ DP │ CC │\n");
        output.push_str("├──────┼──────┼────────┼────┼────┼──────┼──────┼──────┼──────┼────┼────┤\n");
        
        for step in 0..steps {
            let pc = cpu.pc;
            let opcode = cpu.bus.mem[cpu.pc as usize];
            let a = cpu.a;
            let b = cpu.b;
            let x = cpu.x;
            let y = cpu.y;
            let s = cpu.s;
            let u = cpu.u;
            let dp = cpu.dp;
            // Pack CC flags manually since pack_cc is private
            let cc = (if cpu.cc_e { 0x80 } else { 0 }) |
                     (if cpu.cc_f { 0x40 } else { 0 }) |
                     (if cpu.cc_h { 0x20 } else { 0 }) |
                     (if cpu.cc_i { 0x10 } else { 0 }) |
                     (if cpu.cc_n { 0x08 } else { 0 }) |
                     (if cpu.cc_z { 0x04 } else { 0 }) |
                     (if cpu.cc_v { 0x02 } else { 0 }) |
                     (if cpu.cc_c { 0x01 } else { 0 });
            
            output.push_str(&format!(
                "│ {:4} │ {:04X} │   0x{:02X}   │ {:02X} │ {:02X} │ {:04X} │ {:04X} │ {:04X} │ {:04X} │ {:02X} │ {:02X} │\n",
                step, pc, opcode, a, b, x, y, s, u, dp, cc
            ));
            
            cpu.step();
        }
        
        output.push_str("└──────┴──────┴────────┴────┴────┴──────┴──────┴──────┴──────┴────┴────┘\n");
        
        // Escribir archivo
        if let Err(e) = fs::write(&filename, output) {
            println!("Error escribiendo {}: {}", filename, e);
        } else {
            println!("✅ Archivo generado: {}", filename);
        }
    }
    
    println!("\n✅ Todos los archivos de comparación regenerados");
}
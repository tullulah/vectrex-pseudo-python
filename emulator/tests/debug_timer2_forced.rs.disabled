use vectrex_emulator::cpu6809::CPU;

fn load_real_bios(cpu: &mut CPU) {
    let path = r"C:\Users\DanielFerrerGuerrero\source\repos\pseudo-python\ide\frontend\dist\bios.bin";
    let data = std::fs::read(path).expect("BIOS real requerida para test");
    assert_eq!(data.len(), 8192, "BIOS size inesperado");
    for (i, b) in data.iter().enumerate() { 
        let addr = 0xE000 + i as u16; 
        cpu.mem[addr as usize] = *b; 
        cpu.bus.mem[addr as usize] = *b; 
    }
    cpu.bios_present = true;
}

#[test]
fn debug_timer2_forced_expiration() {
    println!("=== Timer2 Forced Expiration Debug ===");
    
    let mut cpu = CPU::default();
    load_real_bios(&mut cpu);
    cpu.reset();
    
    // Run until F19E loop
    let mut step_count = 0;
    while cpu.pc != 0xF19E && step_count < 2000 {
        cpu.step();
        step_count += 1;
    }
    
    if cpu.pc == 0xF19E {
        println!("Reached F19E loop at step {}", step_count);
    } else {
        println!("Did not reach F19E loop after {} steps, PC={:04X}", step_count, cpu.pc);
        return;
    }
    
    // Get initial timer state
    let initial_t2 = cpu.bus.via.read(0x08) as u16 | ((cpu.bus.via.read(0x09) as u16) << 8);
    let initial_ifr = cpu.bus.via.read(0x0D);
    let initial_ier = cpu.bus.via.read(0x0E);
    
    println!("Initial Timer2 state: T2={:04X} ({} decimal), IFR={:02X}, IER={:02X}", 
             initial_t2, initial_t2, initial_ifr, initial_ier);
    
    // FORCE Timer2 to be close to expiration by directly setting its internal counter
    // This is a hack to test the expiration logic without waiting 27k+ cycles
    println!("*** FORCING Timer2 to 10 cycles before expiration ***");
    cpu.bus.via.via.t2_counter = 10;
    
    let forced_t2 = cpu.bus.via.read(0x08) as u16 | ((cpu.bus.via.read(0x09) as u16) << 8);
    println!("After forcing: T2={:04X} (internal={:04X})", forced_t2, cpu.bus.via.via.t2_counter);
    
    // Now step and watch for expiration
    for step in 0..20 {
        let pre_t2_internal = cpu.bus.via.via.t2_counter;
        let pre_t2_read = cpu.bus.via.read(0x08) as u16 | ((cpu.bus.via.read(0x09) as u16) << 8);
        let pre_ifr = cpu.bus.via.read(0x0D);
        let pre_cycles = cpu.cycles;
        
        cpu.step();
        
        let post_t2_internal = cpu.bus.via.via.t2_counter;
        let post_t2_read = cpu.bus.via.read(0x08) as u16 | ((cpu.bus.via.read(0x09) as u16) << 8);
        let post_ifr = cpu.bus.via.read(0x0D);
        let post_cycles = cpu.cycles;
        let step_cycles = post_cycles - pre_cycles;
        
        println!("Step {}: cycles +{}, T2_internal {:04X}->{:04X}, T2_read {:04X}->{:04X}, IFR {:02X}->{:02X}", 
                 step, step_cycles, pre_t2_internal, post_t2_internal, pre_t2_read, post_t2_read, pre_ifr, post_ifr);
        
        // Check for expiration
        if post_t2_internal == 0 && pre_t2_internal > 0 {
            println!("*** Timer2 EXPIRED! ***");
            println!("Final T2_internal: {}, T2_read: {:04X}, IFR: {:02X} (bit5={}), IER: {:02X}", 
                     post_t2_internal,
                     post_t2_read,
                     post_ifr, 
                     (post_ifr & 0x20) != 0,
                     cpu.bus.via.read(0x0E));
        }
        
        // Check for IFR change
        if post_ifr != pre_ifr {
            println!("*** IFR CHANGED from {:02X} to {:02X} ***", pre_ifr, post_ifr);
            if post_ifr & 0x20 != 0 {
                println!("*** IFR5 (Timer2) FLAG NOW SET! ***");
            }
        }
        
        // Check if loop breaks
        if cpu.pc != 0xF19E && cpu.pc != 0xF1A0 {
            println!("*** LOOP BROKEN! PC now at {:04X} ***", cpu.pc);
            break;
        }
        
        // Safety exit after expiration
        if post_t2_internal == 0 && step > 5 {
            println!("*** Timer2 expired, observing a few more steps then stopping ***");
            if step > 10 {
                break;
            }
        }
    }
    
    println!("\nFinal state:");
    println!("PC: {:04X}", cpu.pc);
    println!("T2_internal: {:04X}", cpu.bus.via.via.t2_counter);
    println!("T2_read: {:04X}", cpu.bus.via.read(0x08) as u16 | ((cpu.bus.via.read(0x09) as u16) << 8));
    println!("IFR: {:02X}", cpu.bus.via.read(0x0D));
    println!("IER: {:02X}", cpu.bus.via.read(0x0E));
}
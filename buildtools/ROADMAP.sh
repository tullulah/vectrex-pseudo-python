#!/usr/bin/env bash
# buildtools ROADMAP
# Shows compilation pipeline with status and dependencies

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                   VECTREX VPY COMPILER PIPELINE (buildtools)              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "STATUS LEGEND:"
echo "  âœ…  = Complete + tested"
echo "  ğŸ”„  = In progress"  
echo "  â³  = Planned"
echo "  âš ï¸  = Blocked or critical"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "PIPELINE PHASES:"
echo ""
echo "  INPUT"
echo "    â”‚"
echo "    â”œâ”€ .vpyproj (metadata + config)"
echo "    â”œâ”€ .vpy files (source code)"
echo "    â”œâ”€ .vec files (vector assets)"
echo "    â””â”€ .vmus files (music assets)"
echo ""

echo "  âœ…  PHASE 1: vpy_loader (413 lines)"
echo "      â”‚ Load project metadata and discover files"
echo "      â”‚ âœ“ Parse TOML config"
echo "      â”‚ âœ“ Discover .vpy files recursively"
echo "      â”‚ âœ“ Detect single vs multibank"
echo "      â”‚"
echo "      â””â”€â”€â†’ ProjectInfo { metadata, files, assets }"
echo ""

echo "  â³  PHASE 2: vpy_parser (~1000 lines, port from core)"
echo "      â”‚ Lex + Parse VPy source to AST"
echo "      â”‚ â³ Define AST types (Module, Item, Expr, Stmt)"
echo "      â”‚ â³ Port lexer + parser logic"
echo "      â”‚ â³ Create 10+ unit tests"
echo "      â”‚"
echo "      â””â”€â”€â†’ Vec<Module> { AST per file }"
echo ""

echo "  â³  PHASE 3: vpy_unifier (~500 lines, port from core)"
echo "      â”‚ Resolve imports, merge modules"
echo "      â”‚ â³ Import graph traversal"
echo "      â”‚ â³ Detect circular imports"
echo "      â”‚ â³ Create unified symbol table"
echo "      â”‚"
echo "      â””â”€â”€â†’ UnifiedModule { merged AST + symbols }"
echo ""

echo "  â³  PHASE 4: vpy_bank_allocator (NEW, ~400 lines)"
echo "      â”‚ Assign functions to banks (graph analysis)"
echo "      â”‚ â³ Call graph construction"
echo "      â”‚ â³ Function placement strategy"
echo "      â”‚ â³ Support single (1 bank) + multibank (32 banks)"
echo "      â”‚"
echo "      â””â”€â”€â†’ BankLayout { assignments + map }"
echo ""

echo "  â³  PHASE 5: vpy_codegen (~2000 lines, port from core)"
echo "      â”‚ Generate M6809 assembly per bank"
echo "      â”‚ â³ Emit ASM with metadata"
echo "      â”‚ â³ Handle builtins + helpers"
echo "      â”‚ â³ Generate per-bank ASM files"
echo "      â”‚"
echo "      â””â”€â”€â†’ GeneratedIR { per-bank ASM + symbols }"
echo ""

echo "  â³  PHASE 6: vpy_assembler (~800 lines, port from core)"
echo "      â”‚ Assemble M6809 ASM to object files"
echo "      â”‚ â³ Parse assembly instructions"
echo "      â”‚ â³ Extract symbols + relocations"
echo "      â”‚ â³ Produce object format"
echo "      â”‚"
echo "      â””â”€â”€â†’ Vec<ObjectFile> { bytes + symbols + relocs }"
echo ""

echo "  âš ï¸  PHASE 7: vpy_linker (NEW, ~600 lines) â­ CRITICAL"
echo "      â”‚ REAL linker: place code + resolve symbols"
echo "      â”‚ âš ï¸  THIS IS THE SOURCE OF TRUTH FOR ADDRESSES"
echo "      â”‚ â³ Address space allocation (0x0000-0x7FFF)"
echo "      â”‚ â³ Apply relocations"
echo "      â”‚ â³ Generate symbol table with FINAL addresses"
echo "      â”‚ â³ Support multibank (32 banks, 0x4000 fixed window)"
echo "      â”‚"
echo "      â””â”€â”€â†’ LinkedBinary { binary + symbols + sections }"
echo ""

echo "  â³  PHASE 8: vpy_binary_writer (trivial, ~50 lines)"
echo "      â”‚ Write linked binary to .bin file"
echo "      â”‚ â³ Write bytes to disk"
echo "      â”‚"
echo "      â””â”€â”€â†’ game.bin (512KB for multibank, 32KB for single)"
echo ""

echo "  â³  PHASE 9: vpy_debug_gen (NEW, ~400 lines)"
echo "      â”‚ Generate .pdb from linker output"
echo "      â”‚ â³ Derive symbols from linker (guaranteed correct)"
echo "      â”‚ â³ Map addresses to source lines"
echo "      â”‚ â³ Output JSON format for IDE"
echo "      â”‚"
echo "      â””â”€â”€â†’ game.pdb { symbols + source map }"
echo ""

echo "  OUTPUT"
echo "    â”‚"
echo "    â”œâ”€ game.bin (executable ROM)"
echo "    â””â”€ game.pdb (debugging symbols)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "DEPENDENCY GRAPH:"
echo ""
echo "  vpy_loader"
echo "      â†“"
echo "  vpy_parser"
echo "      â†“"
echo "  vpy_unifier"
echo "      â†“"
echo "  vpy_bank_allocator (NEW, critical)"
echo "      â†“"
echo "  vpy_codegen"
echo "      â†“"
echo "  vpy_assembler"
echo "      â†“"
echo "  vpy_linker â­ (NEW, source of truth)"
echo "      â”œâ”€â†’ vpy_binary_writer (write .bin)"
echo "      â””â”€â†’ vpy_debug_gen (derive .pdb)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "TESTING STRATEGY:"
echo ""
echo "  Every phase tests with:"
echo "    âœ“ Single-bank: code fits in 32KB"
echo "    âœ“ Multibank: code distributed across 32Ã—16KB banks"
echo "    âœ“ Error cases: invalid input handling"
echo ""
echo "  Test files:"
echo "    - buildtools/vpy_loader/src/lib.rs (5 tests)"
echo "    - buildtools/vpy_parser/tests/ (10+ tests) â³"
echo "    - buildtools/vpy_unifier/tests/ (5+ tests) â³"
echo "    - ... (per crate)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "TIMELINE:"
echo ""
echo "  Phase 1: vpy_loader       âœ… COMPLETE (0.5 days)"
echo "  Phase 2: vpy_parser       â³ NEXT (1-2 days)"
echo "  Phase 3: vpy_unifier      â³ (1 day)"
echo "  Phase 4: vpy_bank_allocator â³ (2 days, NEW)"
echo "  Phase 5: vpy_codegen      â³ (2 days)"
echo "  Phase 6: vpy_assembler    â³ (1 day)"
echo "  Phase 7: vpy_linker       â³ (3 days, CRITICAL)"
echo "  Phase 8: vpy_binary_writer â³ (0.5 days)"
echo "  Phase 9: vpy_debug_gen    â³ (1 day, NEW)"
echo "  Integration + tests       â³ (3 days)"
echo ""
echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  TOTAL: ~2 weeks"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "KEY IMPROVEMENTS:"
echo ""
echo "  âœ… Modularity: Each phase independent"
echo "  âœ… Type Safety: No string-based communication"
echo "  âœ… Correctness: Single source of truth (linker)"
echo "  âœ… Testability: Comprehensive test suite"
echo "  âœ… Debuggability: Clear phase boundaries"
echo "  âœ… Multibank: Proper bank allocation + linker"
echo "  âœ… PDB: Derived from authoritative linker"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "FILES CREATED THIS SESSION:"
echo ""
echo "  buildtools/"
echo "  â”œâ”€â”€ Cargo.toml (workspace)"
echo "  â”œâ”€â”€ README.md (overview)"
echo "  â”œâ”€â”€ ARCHITECTURE.md (design)"
echo "  â”œâ”€â”€ STATUS.md (progress)"
echo "  â”œâ”€â”€ SESSION_SUMMARY.md (executive summary)"
echo "  â”œâ”€â”€ PHASE2_PLAN.md (next steps)"
echo "  â”œâ”€â”€ test_buildtools.sh (automation)"
echo "  â”‚"
echo "  â”œâ”€â”€ vpy_loader/ âœ…"
echo "  â”‚   â”œâ”€â”€ Cargo.toml"
echo "  â”‚   â””â”€â”€ src/lib.rs (413 lines, 5 tests)"
echo "  â”‚"
echo "  â””â”€â”€ vpy_parser/ through vpy_debug_gen/ â³"
echo "      (all scaffolded, ready to port)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "NEXT ACTION: Start Phase 2 (vpy_parser)"
echo "See: buildtools/PHASE2_PLAN.md"
echo ""
